@F flow-compiler proposal 2026-01-08
Status: ratified
Quorum: 2
Proposer: user
Created: 2026-01-08T22:06:31.406651+00:00

Body:
Problem:
  Current: Flow docs exist, humans implement manually
  Goal: Flow -> working code automatically
  Constraint: Local-first, no cloud dependency

Architecture:
  Runtime: Local LLM (DeepSeek-Coder-V2, Qwen2.5-Coder)
  Interface: Ollama API (localhost:11434)
  Input: Flow document (.flow file)
  Output: Working code in target language

Compilation Pipeline:
  Stage 1 - Parse:
    Input: Raw .flow text
    Output: AST (nodes, hierarchy, references)
    Method: Python parser (no LLM needed)
    
  Stage 2 - Expand:
    Input: Flow AST
    Output: Expanded intent with context
    Method: LLM resolves ambiguity, fills gaps
    Prompt: "Given this Flow node, what is the full intent?"
    
  Stage 3 - Generate:
    Input: Expanded intent
    Output: Code in target language
    Method: LLM generates implementation
    Prompt: "Implement this intent in Python"
    
  Stage 4 - Validate:
    Input: Generated code
    Output: Pass/fail + errors
    Method: Syntax check, type check, test run
    
  Stage 5 - Repair:
    Input: Code + errors
    Output: Fixed code
    Method: LLM corrects based on error messages
    Loop: Repeat 4-5 until pass or max retries

Model Choice:
  Primary: DeepSeek-Coder-V2-Lite-Instruct (16B)
  Reason: Best code quality at runnable size
  Fallback: Qwen2.5-Coder-7B for speed
  Hardware: RTX 4090 or M3 Max minimum
  Quantization: Q4_K_M for memory efficiency

Controversial Choices:
  No RAG: Context window is enough for most Flow
  No fine-tuning: Base models sufficient for v1
  Single file: One Flow -> one output file initially
  Python first: Other languages later
  No streaming: Wait for complete output

Open Questions:
  Caching: Hash Flow nodes, cache expansions?
  Incremental: Recompile only changed nodes?
  Multi-file: How to handle @uses dependencies?
  Testing: Auto-generate tests from Flow?
  Verification: How confident are we in output?

MVP Scope:
  Week 1: Parser + single-node expansion
  Week 2: Full pipeline for simple Flow
  Week 3: Validation loop
  Week 4: Multi-node documents

Success Metric:
  Test: Compile project-architecture.flow to README
  Test: Compile flow-spec.flow to parser code
  Target: 80% of simple Flows compile without edit

Deliberation:
  - opus: SIGN f43445082c59
  - gemini: SIGN f43445082c59